from telegram.ext import Updater, CommandHandler
import logging
import json
import os
from dotenv import load_dotenv

load_dotenv()

OPEN_POSITIONS_FILE = "open_positions.json"

logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)

def start(update, context):
    update.message.reply_text("Ù…Ø±Ø­Ø¨Ù‹Ø§! Ø§Ø³ØªØ®Ø¯Ù… /help Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©.")

def help_command(update, context):
    commands = """
/start - Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
/help - Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø±
/status - Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª
/positions - Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©
/stop - Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª Ù…Ø¤Ù‚ØªÙ‹Ø§ (ØªØ­ØªØ§Ø¬ ØªÙ†ÙÙŠØ°)
/resume - Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„Ø¨ÙˆØª (ØªØ­ØªØ§Ø¬ ØªÙ†ÙÙŠØ°)
"""
    update.message.reply_text(commands)

def status(update, context):
    update.message.reply_text("âœ… Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ.")

def positions(update, context):
    if os.path.exists(OPEN_POSITIONS_FILE):
        with open(OPEN_POSITIONS_FILE, "r") as f:
            positions = json.load(f)
        if positions:
            msg = "ğŸ“Š Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©:\n"
            for pos in positions:
                msg += f"{pos['symbol']} - Ø§Ù„ÙƒÙ…ÙŠØ©: {pos['quantity']} - Ø³Ø¹Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„: {pos['entry_price']}\n"
        else:
            msg = "ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙ‚Ø§Øª Ù…ÙØªÙˆØ­Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§."
    else:
        msg = "ğŸš« Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø§Ù„ØµÙÙ‚Ø§Øª."

    update.message.reply_text(msg)

def stop_bot(update, context):
    update.message.reply_text("ğŸ›‘ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª Ù…Ø¤Ù‚ØªÙ‹Ø§ (Ø®Ø§ØµÙŠØ© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±).")

def resume_bot(update, context):
    update.message.reply_text("â–¶ï¸ ØªÙ… Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„Ø¨ÙˆØª (Ø®Ø§ØµÙŠØ© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±).")

def main():
    TOKEN = os.getenv("7800699278:AAEdMakvUEwysq-s0k9MsK6k4b4ucyHRfT4")
    updater = Updater(TOKEN, use_context=True)
    dp = updater.dispatcher

    dp.add_handler(CommandHandler("start", start))
    dp.add_handler(CommandHandler("help", help_command))
    dp.add_handler(CommandHandler("status", status))
    dp.add_handler(CommandHandler("positions", positions))
    dp.add_handler(CommandHandler("stop", stop_bot))
    dp.add_handler(CommandHandler("resume", resume_bot))

    updater.start_polling()
    updater.idle()

if name == "__main__":
    main()
