import os
import json
from dotenv import load_dotenv
from telegram import Update
from telegram.ext import ApplicationBuilder, CommandHandler, ContextTypes

load_dotenv()
OPEN_POSITIONS_FILE = "open_positions.json"

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("مرحبًا! استخدم /help لمعرفة الأوامر المتاحة.")

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    commands = """
/start - بدء المحادثة
/help - قائمة الأوامر
/status - حالة البوت
/positions - الصفقات المفتوحة
/stop - إيقاف البوت مؤقتًا (تحتاج تنفيذ)
/resume - استئناف البوت (تحتاج تنفيذ)
"""
    await update.message.reply_text(commands)

async def status(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("✅ البوت يعمل بشكل طبيعي.")

async def positions(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if os.path.exists(OPEN_POSITIONS_FILE):
        with open(OPEN_POSITIONS_FILE, "r") as f:
            positions = json.load(f)
        if positions:
            msg = "📊 الصفقات المفتوحة:\n"
            for pos in positions:
                msg += f"{pos['symbol']} - الكمية: {pos['quantity']} - سعر الدخول: {pos['entry_price']}\n"
        else:
            msg = "🚫 لا توجد صفقات مفتوحة حاليًا."
    else:
        msg = "🚫 لم يتم العثور على ملف الصفقات."
    await update.message.reply_text(msg)

async def stop_bot(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("🛑 تم إيقاف البوت مؤقتًا (خاصية قيد التطوير).")

async def resume_bot(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("▶️ تم استئناف البوت (خاصية قيد التطوير).")

def main():
    TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
    if not TOKEN:
        print("❌ لم يتم تعيين TELEGRAM_BOT_TOKEN في ملف .env")
        return

    application = ApplicationBuilder().token(TOKEN).build()

    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("status", status))
    application.add_handler(CommandHandler("positions", positions))
    application.add_handler(CommandHandler("stop", stop_bot))
    application.add_handler(CommandHandler("resume", resume_bot))

    application.run_polling()

if name == "__main__":
    main()
