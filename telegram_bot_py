import os
import json
from dotenv import load_dotenv
from telegram import Update
from telegram.ext import ApplicationBuilder, CommandHandler, ContextTypes

load_dotenv()
OPEN_POSITIONS_FILE = "open_positions.json"

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("Ù…Ø±Ø­Ø¨Ù‹Ø§! Ø§Ø³ØªØ®Ø¯Ù… /help Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©.")

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    commands = """
/start - Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
/help - Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø±
/status - Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª
/positions - Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©
/stop - Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª Ù…Ø¤Ù‚ØªÙ‹Ø§ (ØªØ­ØªØ§Ø¬ ØªÙ†ÙÙŠØ°)
/resume - Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„Ø¨ÙˆØª (ØªØ­ØªØ§Ø¬ ØªÙ†ÙÙŠØ°)
"""
    await update.message.reply_text(commands)

async def status(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("âœ… Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ.")

async def positions(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if os.path.exists(OPEN_POSITIONS_FILE):
        with open(OPEN_POSITIONS_FILE, "r") as f:
            positions = json.load(f)
        if positions:
            msg = "ğŸ“Š Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©:\n"
            for pos in positions:
                msg += f"{pos['symbol']} - Ø§Ù„ÙƒÙ…ÙŠØ©: {pos['quantity']} - Ø³Ø¹Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„: {pos['entry_price']}\n"
        else:
            msg = "ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙ‚Ø§Øª Ù…ÙØªÙˆØ­Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§."
    else:
        msg = "ğŸš« Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø§Ù„ØµÙÙ‚Ø§Øª."
    await update.message.reply_text(msg)

async def stop_bot(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("ğŸ›‘ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª Ù…Ø¤Ù‚ØªÙ‹Ø§ (Ø®Ø§ØµÙŠØ© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±).")

async def resume_bot(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("â–¶ï¸ ØªÙ… Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„Ø¨ÙˆØª (Ø®Ø§ØµÙŠØ© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±).")

def main():
    TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
    if not TOKEN:
        print("âŒ Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† TELEGRAM_BOT_TOKEN ÙÙŠ Ù…Ù„Ù .env")
        return

    application = ApplicationBuilder().token(TOKEN).build()

    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("status", status))
    application.add_handler(CommandHandler("positions", positions))
    application.add_handler(CommandHandler("stop", stop_bot))
    application.add_handler(CommandHandler("resume", resume_bot))

    application.run_polling()

if name == "__main__":
    main()
